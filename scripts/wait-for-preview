#!/usr/bin/env bash
# Wait for Cloudflare Pages preview URL on a PR
# Usage: scripts/wait-for-preview <PR_NUMBER>
#
# Waits for the GitHub Actions deploy workflow to succeed, then extracts
# the preview URL from the workflow's PR comment.
# Times out after 120 seconds.

set -euo pipefail

PR_NUMBER="${1:-}"

if [[ -z "$PR_NUMBER" ]]; then
  echo "Usage: scripts/wait-for-preview <PR_NUMBER>" >&2
  exit 1
fi

MAX_WAIT=120
INTERVAL=10

echo "Waiting for Cloudflare Pages preview URL on PR #$PR_NUMBER..." >&2

# Get the current head commit SHA for the PR
head_sha=$(gh pr view "$PR_NUMBER" --json headRefOid --jq '.headRefOid')
short_sha="${head_sha:0:7}"
echo "  Expected commit: $short_sha" >&2

start_time=$(date +%s)
while true; do
  # Check if the deploy workflow has completed for this commit
  run_status=$(gh api "repos/{owner}/{repo}/actions/runs?head_sha=$head_sha&event=pull_request" \
    --jq '.workflow_runs[] | select(.name == "Deploy to Cloudflare Pages") | {status, conclusion}' 2>/dev/null | head -1)

  if [[ -n "$run_status" ]]; then
    status=$(echo "$run_status" | jq -r '.status')
    conclusion=$(echo "$run_status" | jq -r '.conclusion')

    if [[ "$status" == "completed" ]]; then
      if [[ "$conclusion" == "success" ]]; then
        # Workflow succeeded - get the preview URL from the PR comment
        preview_url=$(gh api "repos/{owner}/{repo}/issues/$PR_NUMBER/comments" \
          --jq '.[] | select(.user.login == "github-actions[bot]" or .user.type == "Bot") |
                select(.body | contains("Cloudflare Pages Deployment")) |
                .body | capture("Preview: (?<url>https://[^\\s]+)") | .url' 2>/dev/null | tail -1)

        if [[ -n "$preview_url" ]]; then
          echo "$preview_url"
          exit 0
        else
          echo "  Workflow succeeded but no preview URL comment found yet..." >&2
        fi
      else
        echo "Deploy workflow failed with conclusion: $conclusion" >&2
        exit 1
      fi
    else
      echo "  Workflow status: $status..." >&2
    fi
  fi

  elapsed=$(($(date +%s) - start_time))
  if [[ $elapsed -ge $MAX_WAIT ]]; then
    echo "Timeout waiting for preview URL after ${MAX_WAIT}s" >&2
    exit 1
  fi

  echo "  Still waiting... (${elapsed}s elapsed)" >&2
  sleep "$INTERVAL"
done
