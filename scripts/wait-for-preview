#!/usr/bin/env bash
# Wait for Cloudflare Pages preview URL on a PR
# Usage: scripts/wait-for-preview <PR_NUMBER>
#
# Polls for the Cloudflare Pages bot comment until a successful deployment
# is found for the current PR head commit, then outputs the preview URL.
# Times out after 120 seconds.

set -euo pipefail

PR_NUMBER="${1:-}"

if [[ -z "$PR_NUMBER" ]]; then
  echo "Usage: scripts/wait-for-preview <PR_NUMBER>" >&2
  exit 1
fi

MAX_WAIT=120
INTERVAL=10

echo "Waiting for Cloudflare Pages preview URL on PR #$PR_NUMBER..." >&2

# Get the current head commit SHA for the PR
head_sha=$(gh pr view "$PR_NUMBER" --json headRefOid --jq '.headRefOid')
short_sha="${head_sha:0:7}"
echo "  Expected commit: $short_sha" >&2

start_time=$(date +%s)
while true; do
  # Extract both commit and preview URL from successful deployments
  result=$(gh api "repos/:owner/:repo/issues/$PR_NUMBER/comments" --jq '
    .[] | select(.user.login | startswith("cloudflare")) |
    select(.body | contains("Deploy successful")) |
    .body | {
      commit: (capture("<code>(?<sha>[a-f0-9]+)</code>") | .sha),
      url: (capture("Preview URL:</strong></td><td>\\n<a href=.(?<url>https://[^>]+).>") | .url)
    } | "\(.commit) \(.url)"
  ' 2>/dev/null | tail -1)

  if [[ -n "$result" ]]; then
    comment_sha=$(echo "$result" | cut -d' ' -f1)
    preview_url=$(echo "$result" | cut -d' ' -f2)

    if [[ "$comment_sha" == "$short_sha" ]]; then
      echo "$preview_url"
      exit 0
    else
      echo "  Found deployment for $comment_sha, waiting for $short_sha..." >&2
    fi
  fi

  elapsed=$(($(date +%s) - start_time))
  if [[ $elapsed -ge $MAX_WAIT ]]; then
    echo "Timeout waiting for preview URL after ${MAX_WAIT}s" >&2
    exit 1
  fi

  echo "  Still waiting... (${elapsed}s elapsed)" >&2
  sleep "$INTERVAL"
done
